name: Daily Digest

on:
  schedule:
    # Every day at 08:00 UTC (09:00 CET / 10:00 CEST)
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (generate HTML file, do not send email)'
        required: false
        default: 'false'
        type: boolean

jobs:
  daily-digest:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: scripts/package-lock.json

      - name: Install scraper dependencies
        working-directory: scripts
        run: npm ci
        timeout-minutes: 2

      - name: Run daily digest
        working-directory: scripts
        env:
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          PLAUSIBLE_API_KEY: ${{ secrets.PLAUSIBLE_API_KEY }}
          MAILERLITE_API_KEY: ${{ secrets.MAILERLITE_API_KEY }}
          SUMMARY_FILE: ${{ runner.temp }}/digest-summary.json
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            npx tsx send-daily-digest.ts --dry-run
          else
            npx tsx send-daily-digest.ts
          fi

      - name: Generate job summary
        if: always()
        run: |
          SUMMARY_FILE="${{ runner.temp }}/digest-summary.json"
          if [ ! -f "$SUMMARY_FILE" ]; then
            echo "## Daily Digest Summary" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> No summary file found â€” script may have crashed before completion." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          PENDING=$(jq '.pendingTotal' "$SUMMARY_FILE")
          CORRECTIONS=$(jq '.pendingCorrections' "$SUMMARY_FILE")
          SUBMISSIONS=$(jq '.pendingSubmissions' "$SUMMARY_FILE")
          OPTOUTS=$(jq '.pendingOptouts' "$SUMMARY_FILE")
          INQUIRIES=$(jq '.pendingInquiries' "$SUMMARY_FILE")
          NEW_EVENTS=$(jq '.newEvents24h' "$SUMMARY_FILE")
          TOTAL_EVENTS=$(jq '.totalActiveEvents' "$SUMMARY_FILE")
          VISITORS=$(jq -r '.visitors // "N/A"' "$SUMMARY_FILE")
          SUBSCRIBERS=$(jq -r '.subscribers // "N/A"' "$SUMMARY_FILE")
          EXPIRING=$(jq '.expiringPlacements' "$SUMMARY_FILE")
          SENT=$(jq -r '.emailSent' "$SUMMARY_FILE")

          STATUS="âœ… All clear"
          if [ "$PENDING" -gt 0 ]; then STATUS="ðŸ“‹ $PENDING pending task(s)"; fi
          if [ "$NEW_EVENTS" -eq 0 ]; then STATUS="âš ï¸ No new events in 24h"; fi

          echo "## Daily Digest Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Status | ${STATUS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Pending total | ${PENDING} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| â€” Corrections | ${CORRECTIONS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| â€” Submissions | ${SUBMISSIONS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| â€” Data inquiries | ${OPTOUTS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| â€” Inquiries | ${INQUIRIES} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| New events (24h) | ${NEW_EVENTS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Active events | ${TOTAL_EVENTS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Yesterday visitors | ${VISITORS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Subscribers | ${SUBSCRIBERS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Expiring placements | ${EXPIRING} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Email sent | ${SENT} |" >> "$GITHUB_STEP_SUMMARY"
