name: Monthly Quality Audit

on:
  schedule:
    # 1st of every month at 09:00 UTC (10:00 CET / 11:00 CEST)
    - cron: '0 9 1 * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (generate HTML file, do not send email)'
        required: false
        default: 'false'
        type: boolean

jobs:
  quality-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: scripts/package-lock.json

      - name: Install scraper dependencies
        working-directory: scripts
        run: npm ci
        timeout-minutes: 2

      - name: Run quality audit
        working-directory: scripts
        env:
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          SUMMARY_FILE: ${{ runner.temp }}/audit-summary.json
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            npx tsx send-quality-audit.ts --dry-run
          else
            npx tsx send-quality-audit.ts
          fi

      - name: Generate job summary
        if: always()
        run: |
          SUMMARY_FILE="${{ runner.temp }}/audit-summary.json"
          if [ ! -f "$SUMMARY_FILE" ]; then
            echo "## Monthly Quality Audit" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> No summary file found â€” script may have crashed before completion." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          TOTAL=$(jq '.total' "$SUMMARY_FILE")
          PASS=$(jq '.pass' "$SUMMARY_FILE")
          WARNINGS=$(jq '.warnings' "$SUMMARY_FILE")
          FAILURES=$(jq '.failures' "$SUMMARY_FILE")
          MONTH=$(jq -r '.month' "$SUMMARY_FILE")
          SENT=$(jq -r '.emailSent' "$SUMMARY_FILE")

          if [ "$FAILURES" -gt 0 ]; then
            STATUS="ðŸ”´ ${FAILURES} failure(s)"
          elif [ "$WARNINGS" -gt 0 ]; then
            STATUS="ðŸŸ¡ ${WARNINGS} warning(s)"
          else
            STATUS="ðŸŸ¢ All checks passed"
          fi

          echo "## Monthly Quality Audit â€” ${MONTH}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Status | ${STATUS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Total checks | ${TOTAL} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| âœ… Pass | ${PASS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| âš ï¸ Warnings | ${WARNINGS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| âŒ Failures | ${FAILURES} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Email sent | ${SENT} |" >> "$GITHUB_STEP_SUMMARY"
