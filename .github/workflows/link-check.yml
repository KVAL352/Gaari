name: Check Links

on:
  schedule:
    # Daily at 08:00 UTC (2h after morning scrape, so expired events are already cleaned)
    - cron: '0 8 * * *'
  workflow_dispatch: # Manual trigger from GitHub UI

jobs:
  check-links:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: scripts/package-lock.json

      - name: Install scraper dependencies
        working-directory: scripts
        run: npm ci
        timeout-minutes: 2

      - name: Check links
        working-directory: scripts
        env:
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUMMARY_FILE: ${{ runner.temp }}/link-check-summary.json
        run: npx tsx check-links.ts

      - name: Generate job summary
        if: always()
        run: |
          SUMMARY_FILE="${{ runner.temp }}/link-check-summary.json"
          if [ ! -f "$SUMMARY_FILE" ]; then
            echo "## Link Check Summary" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> No summary file found â€” script may have crashed before completion." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          CHECKED=$(jq '.checked' "$SUMMARY_FILE")
          HEALTHY=$(jq '.healthy' "$SUMMARY_FILE")
          SKIPPED=$(jq '.skipped' "$SUMMARY_FILE")
          STRIKES=$(jq '.strikes' "$SUMMARY_FILE")
          DELETED=$(jq '.deleted' "$SUMMARY_FILE")
          CLEARED=$(jq '.ticketsCleared' "$SUMMARY_FILE")
          DURATION=$(jq '.durationSeconds' "$SUMMARY_FILE")

          echo "## Link Check Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Events checked | ${CHECKED} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Healthy | ${HEALTHY} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Skipped (bot-hostile) | ${SKIPPED} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| New strikes | ${STRIKES} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Events deleted | ${DELETED} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Tickets cleared | ${CLEARED} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Duration | ${DURATION}s |" >> "$GITHUB_STEP_SUMMARY"
